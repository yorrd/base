<link rel="import" href="./redux-mixin.html">
<script>
import DatabaseHolder from './database-holder';

MongoReduxMixin = (Parent, CollectionName, StatePath) => class MongoReduxMixin extends AdornisPolymerRedux(Parent) {
    static get actions() {
        return {
            insert(doc) {
                return {
                    type: 'INSERT_DOC',
                    collection: CollectionName,
                    statePath: StatePath,
                    doc,
                };
            },
            remove(id) {
                return {
                    type: 'REMOVE_DOC',
                    collection: CollectionName,
                    statePath: StatePath,
                    id,
                };
            },
            filter(filter) {
                return {
                    type: 'SET_FILTER',
                    collection: CollectionName,
                    statePath: StatePath,
                    filter,
                };
            },
        };
    }

    ready() {
        super.ready();
        if (!CollectionName || !StatePath) { throw new Error('no collection name given'); }

        // create observers for the database redux statePath
        Object.keys(this.constructor.properties)
            .filter(prop => this.constructor.properties[prop].statePath === StatePath)
            .forEach((prop) => {
                this._createMethodObserver(`_arrayUpdate(${prop}.*)`);
            });

        // listen for filter change
        this._createPropertyObserver('filter', '_changeFilter');

        // show warning if you don't have a filter
        if (!Object.keys(this.constructor.properties).includes('filter')) {
            console.error(`You don't have a filter for ${StatePath} on collection ${CollectionName}`);
        }
    }

    _arrayUpdate(diff) { // eslint-disable-line class-methods-use-this
        // this should only run if there are deeper level updates in an object within the array from the database
        if (diff.path.indexOf('.') === -1) return;
        const id = (diff.path.split('.')[1]);
        const dbObj = diff.base[id];
        // will automatically trigger the mongo observer which will then update the data in the store
        DatabaseHolder.getDatabase(CollectionName).update({ _id: dbObj._id }, { $set: dbObj });
    }

    _changeFilter() {
        this.dispatch('filter', this.filter);
    }
};
</script>
